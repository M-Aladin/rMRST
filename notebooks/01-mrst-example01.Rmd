---
title: "R Notebook"
output: html_notebook
---

```{r}
library(rMRST)
library(tibble)

Grid.Nx =8; Grid.hx=1/Grid.Nx;
Grid.Ny =8; Grid.hy=1/Grid.Ny;
Grid.Nz =1; Grid.hz=1/Grid.Nz;

Grid.K = m.ones(3, Grid.Nx, Grid.Ny);
dim(Grid.K)
N <-  Grid.Nx * Grid.Ny * Grid.Nz
N
q = m.zeros(N, 1) 
q[c(N, 1)] = c(1, -1)
dim(q)
summary(q)
```

## Build the grid

```{r}
library(RcppOctave)

# function to build the Grid
o.buildGrid <- OctaveFunction("
function[Grid] = buildGrid(Nx, Ny, Nz)
    Grid.Nx = Nx; Grid.hx=1/Grid.Nx;
    Grid.Ny = Ny; Grid.hy=1/Grid.Ny;
    Grid.Nz = Nz; Grid.hz=1/Grid.Nz;
    % Grid.K = K
")

Nx <- 8
Ny <- 8
Nz <- 1
# permeability
K = m.ones(3, Nx, Ny);
# build the grid
Grid <- o.buildGrid(Nx, Ny, Nz)
# names(Grid)
q = m.zeros(N, 1) 
q[c(N, 1)] = c(1, -1)
```

```{r}
library(rMRST)

# TPFA <- function(Grid, K, q) {
    with(as.list(Grid), {
        # Compute transmissibilities by harmonic averaging.
        Nx = Grid.Nx; Ny=Grid.Ny; Nz=Grid.Nz; N=Nx*Ny*Nz;
        hx = Grid.hx; hy=Grid.hy; hz=Grid.hz;
        
        L <- K^(-1)      # 3x8x8 array
        
        tx = 2*hy*hz/hx; TX <- zeros(Nx+1,Ny,Nz);
        ty = 2*hx*hz/hy; TY = zeros(Nx,Ny+1,Nz);
        tz = 2*hx*hy/hz; TZ = zeros(Nx,Ny,Nz+1);
        
        TX[2:Nx,,] = tx / (L[1, 1:(Nx-1), ] + L[1, 2:Nx, ])
        TY[,2:Ny,] = ty / (L[2, , 1:Ny-1] + L[2, ,2:Ny])
        TZ[,,2:Nz] = tz / (L[3,,1:(Nz-1)]   + L[3, ,2:Nz])
        
        x1 = pracma::Reshape(TX[1:Nx,,],N,1); x2 = pracma::Reshape(TX[2:(Nx+1),,],N,1);
        y1 = pracma::Reshape(TY[,1:Ny,],N,1); y2 = pracma::Reshape(TY[,2:(Ny+1),],N,1);
        z1 = pracma::Reshape(TZ[,,1:Nz],N,1); z2 = pracma::Reshape(TZ[,,2:(Nz+1)],N,1);
        
        DiagVecs = c(-z2,-y2,-x2,x1+x2+y1+y2+z1+z2,-x1,-y1,-z1)
        DiagIndx = c(-Nx*Ny,-Nx,-1,0,1,Nx,Nx*Ny)
        
        # A = m.spdiags(DiagVecs,DiagIndx,N,N);
        # A = m.spdiags(N,N);
        # A[1,1] = A[1,1]+sum(Grid.K(:,1,1,1));
                                                                   
    })
# }

# TPFA(Grid, K, q)
```



```{r}
o.TPFA <- OctaveFunction("
function [P,V] = TPFA(Grid, K, q)
    % Compute transmissibilities by harmonic averaging.
    Nx=Grid.Nx; Ny=Grid.Ny; Nz=Grid.Nz; N=Nx*Ny*Nz;
    
    hx=Grid.hx; hy=Grid.hy; hz=Grid.hz;
")

TPFA <- o.TPFA(Grid, K, q)
```


```{r}
# example 1
library(rMRST)

A=rbind(c(0, 5, 0, 10, 0, 0),
c(0, 0, 6, 0, 11, 0),
c(3, 0, 0, 7, 0, 12),
c(1, 4, 0, 0, 8, 0),
c(0, 2, 5, 0, 0, 9)
)
A
m.spdiags(A)
```

```{r}
# example 2
library(rMRST)
n <- 5
e <- m.ones(n, 1)

e5x3 <- cbind(e, -2*e, e)
e5x3

B <- m.spdiags(e5x3, -1:1, n, n)
B
```

